<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>View Agent | Hamza Paints</title>
  <link rel="icon" href="/images/weldon-paints-logo.png" type="image/png">
  <link rel="stylesheet" href="/stylesheets/viewAgent.css">

  <style>
    /* üü¢ NEW LOADER & SPINNER CSS */
    .spinner {
      width: 35px;
      height: 35px;
      border: 4px solid rgba(0, 0, 0, 0.1);
      border-left-color: #06A56C;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin { to { transform: rotate(360deg); } }

    /* Space Fix: Table ke nichay faltu jagah khatam karne ke liye */
    .table-container { 
      position: relative; 
      min-height: 100px; /* Puray page ki jagah nahi gheray ga */
      background: #fff;
      border-radius: 8px;
      margin-bottom: 20px;
    }

    /* Loader Overlay */
    #tableLoader {
      display: none;
      position: absolute;
      top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(255, 255, 255, 0.8);
      z-index: 100;
      justify-content: center;
      align-items: center;
      flex-direction: column;
    }

    .btn-loading { opacity: 0.6; pointer-events: none; }
  </style>
</head>
<body>
  <%- include('partials/navbar') %>

  <main>
    <a href="/agents/all" id="BackBtn"><span class="backbtn">‚Üê</span> All Agents</a>

    <h1>View Agent - <span style="color: #2196F3;"><%= agent.name %></span></h1>

    <div class="filter-container">
      <select id="filter">
        <option value="all" <%= filter === 'all' ? 'selected' : '' %>>All Dates</option>
        <option value="today" <%= filter === 'today' ? 'selected' : '' %>>Today</option>
        <option value="yesterday" <%= filter === 'yesterday' ? 'selected' : '' %>>Yesterday</option>
        <option value="month" <%= filter === 'month' ? 'selected' : '' %>>This Month</option>
        <option value="lastMonth" <%= filter === 'lastMonth' ? 'selected' : '' %>>Last Month</option>
        <option value="custom" <%= filter === 'custom' ? 'selected' : '' %>>Custom Range</option>
      </select>

      <input type="date" id="from" value="<%= from || '' %>" style="display:none;">
      <input type="date" id="to" value="<%= to || '' %>" style="display:none;">
      <button type="button" id="apply">Apply Filter</button>
    </div>

    <div class="stats">
      <div class="stat-box">
        <h3>Total Commission üíµ</h3>
        <p id="stat-total">Rs <%= Number(stats.totalPercentageAmount).toFixed(2) %></p>
      </div>
      <div class="stat-box">
        <h3>Paid Commission ‚úÖ</h3>
        <p id="stat-paid">Rs <%= Number(stats.totalPercentageAmountGiven).toFixed(2) %></p>
      </div>
      <div class="stat-box">
        <h3>Left Commission ‚è≥</h3>
        <p id="stat-left" style="color: #f44336;">Rs <%= Number(stats.totalPercentageAmountLeft).toFixed(2) %></p>
      </div>
    </div>

    <div class="table-container">
      <div id="tableLoader">
        <div class="spinner"></div>
        <p style="margin-top:10px; color:#2196F3; font-weight: bold;">Updating...</p>
      </div>

      <table>
        <thead>
          <tr>
            <th>Product Sold</th>
            <th>Total Amount</th>
            <th>%</th>
            <th>% Amount</th>
            <th>Status</th>
            <th>Paid</th>
            <th>Left</th>
            <th>Date</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody id="agentTableBody">
          <% if (!agent.items || agent.items.length === 0) { %>
            <tr><td colspan="9" class="no-data">No records found.</td></tr>
          <% } else { %>
            <% agent.items.forEach(i => { %>
              <tr id="row-<%= i._id %>">
                <td><%= i.totalProductSold %></td>
                <td><%= i.totalProductAmount %></td>
                <td><%= i.percentage %>%</td>
                <td><%= i.percentageAmount %></td>
                <td class="paid-status">
                  <span class="status-tag">
                    <%= i.paidAmount >= i.percentageAmount ? 'Paid' : (i.paidAmount > 0 ? 'Partially' : 'Unpaid') %>
                  </span>
                </td>
                <td>Rs <%= i.paidAmount %></td>
                <td>Rs <%= (Number(i.percentageAmount) - Number(i.paidAmount)).toFixed(2) %></td>
                <td >
                  <%= new Date(i.createdAt).toLocaleDateString('en-GB') %>
                  <br><small style="color: #007bff; font-weight: bold;"><%= new Date(i.createdAt).toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit', hour12: true }) %></small>
                </td>
                <td class="actions">
                  <button class="pay-btn" data-id="<%= i._id %>" id="pay" >Pay %</button>
                  <% if(role == "admin") { %>
                    <button class="delete-btn" data-id="<%= i._id %>">Delete</button>
                  <% } %>
                  <div class="pay-box" id="paybox-<%= i._id %>" style="display:none;">
                    <input class="payinput" type="number" id="payInput-<%= i._id %>" style="width:70px" placeholder="Pay">
                    <button class="submit-pay-btn" data-id="<%= i._id %>" id="submit" >Submit</button>
                  </div>
                </td>
              </tr>
            <% }) %>
          <% } %>
        </tbody>
      </table>
    </div>
  </main>

  <script src="/javascripts/viewAgent.js"></script>
</body>
</html>