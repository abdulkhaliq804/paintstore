<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <title>Sales History | Hamza Paints</title>
    <link rel="icon" href="/images/weldon-paints-logo.png" type="image/png">
    <link rel="stylesheet" href="/stylesheets/salesHistory.css">
   

</head>

<body>
    <%- include('partials/navbar') %>

    <main>
        <h1>ðŸ“œ Sales History (Bills)</h1>

        <form class="filter-container" id="filterForm" method="GET" action="/sales/history">
            <select name="filter" id="filter">
                <option value="all" <%= filter === 'all' ? 'selected' : '' %>>All Times</option>
                <option value="today" <%= filter === 'today' ? 'selected' : '' %>>Today</option>
                <option value="yesterday" <%= filter === 'yesterday' ? 'selected' : '' %>>Yesterday</option>
                <option value="month" <%= filter === 'month' ? 'selected' : '' %>>This Month</option>
                <option value="lastMonth" <%= filter === 'lastMonth' ? 'selected' : '' %>>Last Month</option>
                <option value="custom" <%= filter === 'custom' ? 'selected' : '' %>>Custom Range</option>
            </select>

            <select name="agentId" id="agentFilter">
                <option value="all">All Agents</option>
                <% agents.forEach(agent => { %>
                    <option value="<%= agent._id %>" <%= selectedAgent == agent._id.toString() ? 'selected' : '' %>>
                        <%= agent.name %>
                    </option>
                <% }) %>
            </select>

            <input type="date" name="from" id="from" value="<%= from || '' %>" style="display:none;">
            <input type="date" name="to" id="to" value="<%= to || '' %>" style="display:none;">
            <button type="submit" id="apply" style="display:none;">Apply</button>
        </form>

        <div class="stats">
            <div class="stat-box">
                <h3>ðŸ§¾ Total Bills</h3>
                <p><%= history.length %></p>
            </div>
            <div class="stat-box">
                <h3>ðŸ’° Total Revenue</h3>
                <p>Rs <%= totalRevenue.toFixed(2) %></p>
            </div>
        </div>

        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th>Date & Time</th>
                        <th>Customer Name</th>
                        <th>Items Count</th>
                        <th>Total Bill</th>
                        <th>Agent</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody>
                    <% if (history.length === 0) { %>
                        <tr>
                            <td colspan="6" class="no-data">No history found.</td>
                        </tr>
                    <% } else { %>
                        <% history.forEach(bill => { 
                            let billTotal = bill.salesItems.reduce((acc, item) => acc + (item.quantitySold * item.rate), 0);
                        %>
                            <tr>
                                <td>
                                    <%= new Date(bill.createdAt).toLocaleDateString('en-GB') %> <br>
                                    <small style="color: #007bff; font-weight: bold;"><%= new Date(bill.createdAt).toLocaleTimeString('en-GB', {hour:'2-digit', minute:'2-digit', hour12:true}) %></small>
                                </td>
                                <td class="customer-name"><%= bill.customerName %></td>
                                <td><%= bill.salesItems.length %> Items</td>
                                <td style="font-weight: bold; color: #06A56C;">Rs <%= billTotal.toFixed(2) %></td>
                                <td>
                                    <% if(bill.agentId) { %>
                                        <span class="agent-tag"><%= bill.agentId.name %></span>
                                    <% } else { %>
                                        <small>Direct Sale</small>
                                    <% } %>
                                </td>
                              <td>
  <button type="button" class="view-btn action-btn" data-id="<%= bill._id %>" id="view" >View</button>
  <button type="button" class="delete-btn action-btn" data-id="<%= bill._id %>" id="delete">Delete</button>
</td>

                            </tr>
                        <% }) %>
                    <% } %>
                </tbody>
            </table>
        </div>
    </main>

    
    <script src="/javascripts/salesHistory.js"></script>
</body>
</html>