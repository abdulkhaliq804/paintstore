<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <title>All Sales | Hamza Paints</title>
  <link rel="icon" href="/images/weldon-paints-logo.png" type="image/png">
  <link rel="stylesheet" href="/stylesheets/allSales.css">
  <style>
    /* üü¢ Loader & Responsive Table Styling */
    .table-container {
      position: relative;
      width: 100%;
      height: auto !important;
      min-height: unset !important;
      overflow-x: auto !important; /* Mobile scroll fix */
      margin-bottom: 20px;
      background: #fff;
      border-radius: 8px;
    }

    #table-loader {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      min-height: 150px;
      background: rgba(255, 255, 255, 0.7);
      display: none; /* JS control karega */
      justify-content: center;
      align-items: center;
      z-index: 100;
    }

    .spinner {
      width: 45px;
      height: 45px;
      border: 5px solid #f3f3f3;
      border-top: 5px solid #06A56C;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .loading-active table {
      opacity: 0.2;
      pointer-events: none;
    }

    .no-data {
      text-align: center;
      padding: 30px !important;
      color: #888;
      font-weight: bold;
    }

    /* Profit/Loss Colors */
    .profit { color: #28a745; font-weight: bold; }
    .loss { color: #dc3545; font-weight: bold; }
  </style>
</head>

<body>
  <%- include('partials/navbar') %>

  <main>
    <h1>All Sales</h1>

    <form class="filter-container" id="filterForm" method="GET" action="/sales/all">
      <select name="filter" id="filter">
        <option value="all" <%= filter === 'all' ? 'selected' : '' %>>All Times</option>
        <option value="today" <%= filter === 'today' ? 'selected' : '' %>>Today</option>
        <option value="yesterday" <%= filter === 'yesterday' ? 'selected' : '' %>>Yesterday</option>
        <option value="month" <%= (filter === 'month' || !filter) ? 'selected' : '' %>>This Month</option>
        <option value="lastMonth" <%= filter === 'lastMonth' ? 'selected' : '' %>>Last Month</option>
        <option value="custom" <%= filter === 'custom' ? 'selected' : '' %>>Custom Range</option>
      </select>

      <select name="brand" id="brandFilter" data-value="<%= selectedBrand || 'all' %>">
        <option value="all">All Brands</option>
        <option value="Weldon Paints">Weldon Paints</option>
        <option value="Sparco Paints">Sparco Paints</option>
        <option value="Value Paints">Value Paints</option>
        <option value="Corona Paints">Corona Paints</option>
        <option value="Other Paints">Other Paints</option>
      </select>

      <select name="itemName" id="itemNameFilter" data-value="<%= selectedItem || 'all' %>">
        <option value="all">All Items</option>
      </select>

      <select name="colourName" id="colourNameFilter" data-value="<%= selectedColour || 'all' %>">
        <option value="all">All Colours</option>
      </select>

      <select name="unit" id="unitFilter" data-value="<%= selectedUnit || 'all' %>">
        <option value="all">All Units</option>
      </select>

      <select name="refund" id="refundFilter" data-value="<%= selectedRefund || 'all' %>">
        <option value="all">All Status</option>
        <option value="none">Not Refunded</option>
        <option value="Partially Refunded">Partially Refunded</option>
        <option value="Fully Refunded">Fully Refunded</option>
      </select>

      <input type="date" name="from" id="from" value="<%= from || '' %>" style="display:none;">
      <input type="date" name="to" id="to" value="<%= to || '' %>" style="display:none;">
      <button type="submit" id="apply" style="display:none;">Apply Range</button>
    </form>

    <div class="stats">
      <div class="stat-box">
        <h3>üõçÔ∏è Total Sold</h3>
        <p><%= stats.totalSold || 0 %></p>
      </div>
      <div class="stat-box">
        <h3>üìà Total Sales</h3>
        <p>Rs <%= stats.totalRevenue ? stats.totalRevenue.toFixed(2) : '0.00' %></p>
      </div>
      <div class="stat-box">
        <h3>üí∞ Total Profit</h3>
        <p>Rs <%= stats.totalProfit ? stats.totalProfit.toFixed(2) : '0.00' %></p>
      </div>
      <div class="stat-box">
        <h3>üìâ Total Loss</h3>
        <p>Rs <%= stats.totalLoss ? stats.totalLoss.toFixed(2) : '0.00' %></p>
      </div>
      <div class="stat-box">
        <h3>‚Ü©Ô∏è Refund Sales</h3>
        <p>Rs <%= stats.totalRefunded ? stats.totalRefunded.toFixed(2) : '0.00' %></p>
      </div>
    </div>

    <div class="table-container" id="tableContainer">
      <div id="table-loader">
        <div class="spinner"></div>
      </div>

      <table>
        <thead>
          <tr>
            <th>Brand</th>
            <th>Item</th>
            <th>Colour</th>
            <th>Unit</th>
            <th>Qty Sold</th>
            <th>Rate</th>
            <th>Total Amount</th>
            <th>Profit/Loss</th>
            <th>Status</th>
            <th>Refund (Qty)</th>
            <th>Date</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody>
          <% if (sales.length === 0) { %>
            <tr>
              <td colspan="12" class="no-data">No sales found for the selected filter.</td>
            </tr>
          <% } else { %>
            <% sales.forEach(s => { %>
              <tr>
                <td><%= s.brandName %></td>
                <td><%= s.itemName %></td>
                <td><%= s.colourName %></td>
                <td><%= s.qty %></td>
                <td><%= s.quantitySold %></td>
                <td>Rs <%= s.rate.toFixed(2) %></td>
                <td>Rs <%= (s.quantitySold * s.rate).toFixed(2) %></td>
                <td class="<%= s.profit < 0 ? 'loss' : 'profit' %>">
                  Rs <%= Math.abs(s.profit).toFixed(2) %>
                </td>
                <td class="refund-status"><%= s.refundStatus %></td>
                <td class="refund-quantity"><%= s.refundQuantity %></td>
                <td>
                  <%= new Date(s.createdAt).toLocaleDateString('en-GB', { day: '2-digit', month: 'short', year: 'numeric', timeZone: 'Asia/Karachi' }) %>
                  <br>
                  <small style="color: #007bff; font-weight: bold;">
                    <%= new Date(s.createdAt).toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit', hour12: true, timeZone: 'Asia/Karachi' }) %>
                  </small>
                </td>
                <td>
                  <button class="delete-sale delete-btn" data-id="<%= s._id %>" id="delete" >Delete</button>
                </td>
              </tr>
            <% }) %>
          <% } %>
        </tbody>
      </table>
    </div>

    <script src="/javascripts/allSales.js"></script>
  </main>
</body>

</html>